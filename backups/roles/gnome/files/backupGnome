#!/bin/bash
#
bdir=$1
skiprestore=$2
roles=$3
echo "In $0"
echo "  bdir=$bdir"
echo "  skiprestore=$skiprestore"
echo "  roles=$roles"
#
# First, make a dump
#
ofile=$bdir/dconf-`uname -n`
dconf dump / >$ofile
echo "Created $ofile"
#
# Then, create an ansible playbook
#
IFS="
"
headermatch='^\[.*'
odir=$roles/gnome/tasks ; mkdir -p $odir
ofile=$odir/main.yml
echo "Creating $ofile..."
echo "---
# main for gnome
# generated by `basename $0` `date +'on %y.%m.%d at %H:%M:%S '`" >$ofile
for path in /org/gnome/desktop/input-sources        \
            /org/gnome/desktop/interface            \
            /org/gnome/desktop/peripherals/keyboard \
            /org/gnome/desktop/privacy              \
            /org/gnome/desktop/screensaver          \
            /org/gnome/desktop/session              \
            /org/gnome/desktop/wm/keybindings       \
            /org/gnome/nautilus                     \
            /org/gnome/shell/extensions             \
            /org/gnome/terminal/legacy
do
  dconf dump $path/ | while read line
  do
    [[ ! "$line" ]] && continue
    if [[ "$line" =~ $headermatch ]]
    then
      spath=`echo "$line" | cut -d'[' -f2- | cut -d']' -f1`
      if [ "$spath" = "/" ]
      then
        fpath=$path
      else
        fpath=$path/$spath
      fi
      echo "$fpath"
      continue
    fi
    key=$fpath/`echo "$line" | cut -d'=' -f1`
    value=`echo "$line" | cut -d'=' -f2 | sed 's/"/\\\"/g'`
    unset tag1 tag2 tag3
    len=`echo $key | cut -d'/' -f4- | tr '/' ' ' | wc -w`
    [[ "$len" -ge 2 ]] && tag1=`echo $key | cut -d'/' -f4 | sed 's/://'`
    [[ "$len" -ge 3 ]] && tag2=,`echo $key | cut -d'/' -f4-5 | sed 's/://'`
    [[ "$len" -ge 4 ]] && tag3=,`echo $key | cut -d'/' -f4-6 | sed 's/://'`
    echo -e "
- name: `echo $key | cut -d'/' -f4-`
  tags: $tag1$tag2$tag3
  ansible.builtin.dconf:
    key: \"$key\"
    value: \"$value\"
    state: present" >>$ofile
  done
done
#read -p "All done!" a
